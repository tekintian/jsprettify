name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 触发标签推送时触发，如 v1.0, v2.0 等
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16.x, 20.x]  # 只测试最低支持版本和最新稳定版

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: npm ci

    - name: Run build
      run: ./build.sh

    - name: Test executable (Unix/Mac)
      if: runner.os != 'Windows'
      run: |
        chmod +x dist/jsprettify
        node dist/jsprettify test_data/test.min.js test_output.js
        [ -f test_output.js ] && echo "Build successful" || exit 1

    - name: Test executable (Windows)
      if: runner.os == 'Windows'
      run: |
        node dist/jsprettify test_data/test.min.js test_output.js
        if (Test-Path test_output.js) { echo "Build successful" } else { exit 1 }

  release:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm ci

    - name: Run build
      run: ./build.sh

    - name: Prepare assets for release
      run: |
        chmod +x dist/jsprettify dist/run-unix.sh
        # Create a zip archive with all necessary files
        zip -r jsprettify-${{ github.ref_name }}.zip dist/jsprettify dist/run-unix.sh dist/run-windows.ps1 README.md package.json

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          dist/jsprettify
          dist/run-unix.sh
          dist/run-windows.ps1
          jsprettify-${{ github.ref_name }}.zip