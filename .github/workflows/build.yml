name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 触发标签推送时触发，如 v1.0, v2.0 等
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16.x, 20.x]  # 只测试最低支持版本和最新稳定版

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: npm ci

    - name: Run build (Unix/Mac)
      if: runner.os != 'Windows'
      run: ./build.sh

    - name: Run build (Windows)
      if: runner.os == 'Windows'
      run: |
        # Clean previous build and test output
        if (Test-Path dist) {
          Remove-Item dist -Recurse -Force
        }
        if (Test-Path output.js) {
          Remove-Item output.js -Force
        }

        # Build the main executable with ncc
        npx @vercel/ncc build src/index.js -o dist --minify

        # Rename the output to remove the .js extension
        Move-Item dist/index.js dist/jsprettify

        # Copy run scripts to dist directory
        Copy-Item run-windows.ps1 dist/

        Write-Host "Build completed successfully!"
        Get-ChildItem dist/

    - name: Test executable (Unix/Mac)
      if: runner.os != 'Windows'
      run: |
        chmod +x dist/jsprettify
        ./dist/jsprettify test_data/test.min.js output.js
        [ -f output.js ] && echo "Build successful" || exit 1

    - name: Test executable (Windows)
      if: runner.os == 'Windows'
      run: |
        # 在 Windows 上，我们使用 node 直接运行编译后的文件
        # 检查文件是否存在
        if (Test-Path "dist/jsprettify") {
          Write-Host "jsprettify file exists"
          # 尝试使用 node 运行它
          node dist/jsprettify test_data/test.min.js output.js
          $exitCode = $LASTEXITCODE
          if ($exitCode -eq 0) {
            Write-Host "Command executed successfully"
          } else {
            Write-Error "Command failed with exit code: $exitCode"
            exit $exitCode
          }
        } else {
          Write-Error "dist/jsprettify does not exist"
          exit 1
        }
        
        # 检查输出文件是否创建成功
        if (Test-Path output.js) { 
          Write-Host "Build successful" 
        } else { 
          Write-Error "Output file not created"
          exit 1 
        }
      shell: pwsh

  release:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm ci

    - name: Run build
      run: ./build.sh

    - name: Prepare assets for release
      run: |
        chmod +x dist/jsprettify dist/run-unix.sh
        # Create a zip archive with all necessary files
        zip -r jsprettify-${{ github.ref_name }}.zip dist/jsprettify dist/run-unix.sh dist/run-windows.ps1 README.md package.json

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          dist/jsprettify
          dist/run-unix.sh
          dist/run-windows.ps1
          jsprettify-${{ github.ref_name }}.zip